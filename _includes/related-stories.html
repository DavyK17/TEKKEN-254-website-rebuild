{% assign maxRelated = 3 %}
{% assign minCommonTags =  2 %}
{% assign maxRelatedCounter = 0 %}
{% for post in site.posts %}
    {% assign sameTagCount = 0 %}
    {% assign commonTags = "" %}
    {% for tag in post.tags %}
        {% if post.url != page.url %}
            {% if page.tags contains tag %}
                {% assign sameTagCount = sameTagCount | plus: 1 %}
            {% endif %}
        {% endif %}
    {% endfor %}
    {% if sameTagCount >= minCommonTags %}
<section id="related-posts">
    <h2>Related posts</h2>
    <div class="featured-stories row mt-0">
        {% assign maxRelatedCounter = maxRelatedCounter | plus: 1 %}
        {% if maxRelatedCounter == 1 %}
            {% break %}
        {% endif %}
    {% endif %}
{% endfor %}
{% assign maxRelated = 3 %}
{% assign minCommonTags =  2 %}
{% assign maxRelatedCounter = 0 %}
{% for post in site.posts %}
    {% assign sameTagCount = 0 %}
    {% assign commonTags = "" %}
    {% for tag in post.tags %}
        {% if post.url != page.url %}
            {% if page.tags contains tag %}
                {% assign sameTagCount = sameTagCount | plus: 1 %}
            {% endif %}
        {% endif %}
    {% endfor %}
    {% if sameTagCount >= minCommonTags %}
        <div class="card featured-story col-12 col-lg-4">
            <a class="blank-link" href="{{ post.url }}">
                <div class="card-container">
                    <div class="card-img-container">
                        <div class="card-img-top featured-story-img" style="background-image: url('/{% if post.metaImage %}{{ post.metaImage }}{% else %}assets/img/news/{{ post.date | date: "%Y-%m-%d" }}-{{ post.slug }}/meta.{% if post.metaImageExt %}{{ post.metaImageExt }}{% else %}jpg{% endif %}');{% if post.metaImagePosition %} background-position: {{ post.metaImagePosition }};{% else %} background-position: center;{% endif %}{% endif %}"></div>
                    </div>
                    <div class="card-body">
                        <div class="news-card-info">
                            <p class="card-title font-header semi-bold mt-0" role="heading">{{ post.title }}</p>
                            <p class="card-text light">{{ post.description }}</p>
                        </div>
                        <small>    
                                            <ul class="featured-cat-date card-text">
                                                <li class="text-muted date">{{ post.date | date_to_long_string }}</li>
                                                <li class="text-muted category">{{ post.categories | first }}</li>
                                            </ul>
                                        </small>
                    </div>
                </div>
            </a>
        </div>
        {% assign maxRelatedCounter = maxRelatedCounter | plus: 1 %}
        {% if maxRelatedCounter >= maxRelated %}
            {% break %}
        {% endif %}
    {% endif %}
{% endfor %}
{% assign maxRelated = 3 %}
{% assign minCommonTags =  2 %}
{% assign maxRelatedCounter = 0 %}
{% for post in site.posts %}
    {% assign sameTagCount = 0 %}
    {% assign commonTags = "" %}
    {% for tag in post.tags %}
        {% if post.url != page.url %}
            {% if page.tags contains tag %}
                {% assign sameTagCount = sameTagCount | plus: 1 %}
            {% endif %}
        {% endif %}
    {% endfor %}
    {% if sameTagCount >= minCommonTags %}
    </div>
</section>
        {% assign maxRelatedCounter = maxRelatedCounter | plus: 1 %}
        {% if maxRelatedCounter == 1 %}
            {% break %}
        {% endif %}
    {% endif %}
{% endfor %}